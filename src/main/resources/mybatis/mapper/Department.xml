<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="oms.pc_protector.restApi.department.mapper.DepartmentMapper">

    <select id="selectAll"
            resultType="oms.pc_protector.restApi.department.model.DepartmentVO" >
        SELECT * FROM department
    </select>

    <select id="findUserInDepartment" parameterType="String" resultType="Int">
        SELECT COUNT(user_id) FROM user WHERE department = #{value}
    </select>

    <select id="selectByDepartment"
            resultType="oms.pc_protector.restApi.department.model.DepartmentVO" parameterType="String">
        SELECT * FROM department WHERE name = #{value}
    </select>

    <select id="selectBycode"
            resultType="oms.pc_protector.restApi.department.model.DepartmentVO" parameterType="Long">
        SELECT * FROM department WHERE code = #{departmentCode}
    </select>

    <select id="selectChildCodeAscByParentCode" resultType="oms.pc_protector.restApi.department.model.DepartmentVO"
            parameterType="Long">
        SELECT code, name, parent_code
        FROM
            (
                SELECT *
                FROM department
                ORDER BY parent_code, code) products_sorted,
            (
                SELECT @pv := #{departmentCode}) initialisation
        WHERE FIND_IN_SET(parent_code, @pv) > 0 AND @pv := CONCAT(@pv, ',', code)
    </select>

    <select id="selectChildCodeDescByParentCode" resultType="oms.pc_protector.restApi.department.model.DepartmentVO"
    parameterType="Long">
        SELECT code, name, parent_code
        FROM
            (
                SELECT *
                FROM department
                ORDER BY parent_code, code) products_sorted,
            (
                SELECT @pv := #{departmentCode}) initialisation
        WHERE FIND_IN_SET(parent_code, @pv) > 0 AND @pv := CONCAT(@pv, ',', code)
        ORDER BY code desc;
    </select>

    <select id="selectByParentCode"
            resultType="Long" parameterType="Long">
        SELECT code FROM department WHERE parent_code = #{value}
    </select>

    <insert id="registerByExcel" parameterType="oms.pc_protector.restApi.department.model.DepartmentVO">
        INSERT INTO department (name, code, parent_code)
        VALUES (#{name}, #{code}, #{parentCode});
        UPDATE user
        SET department_idx = #{code}
        WHERE department = #{name}
    </insert>

    <insert id="insert" parameterType="oms.pc_protector.restApi.department.model.DepartmentVO">
        INSERT INTO department (name, code, parent_code)
        VALUES (#{name}, #{code}, #{parentCode})
    </insert>

    <update id="update" parameterType="oms.pc_protector.restApi.department.model.UpdateDepartmentVO">
        UPDATE department
        SET name = #{new_name},
            update_time = now()
        WHERE name = #{old_name}
    </update>

    <delete id="deleteAll">
        DELETE FROM department
    </delete>

    <delete id="deleteByDepartment" parameterType="String">
        DELETE FROM department WHERE name = #{value}
    </delete>


</mapper>


