<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="oms.pc_protector.restApi.user.mapper.UserMapper">

    <select id="selectUserInfoAll" resultType="oms.pc_protector.restApi.user.model.UserVO">
        SELECT u.user_id,
               u.department_idx,
               u.department,
               u.name,
               IFNULL(GROUP_CONCAT(ip_address SEPARATOR ' / '), "") AS ip_address,
               u.email,
               u.phone
        FROM user AS u
                 LEFT join client AS c
                           ON u.user_id = c.user_id
        WHERE u.department_idx LIKE CONCAT(#{value}, '%')
        GROUP BY u.user_id
    </select>

    <select id="selectById" resultType="oms.pc_protector.restApi.user.model.UserVO"
            parameterType="String">
        SELECT *
        FROM user u, (SELECT code FROM department WHERE dpt_code = #{code}) d
        WHERE user_id = #{id} AND u.department_idx LIKE CONCAT(d.code, '%')
    </select>

    <select id="selectSameId" resultType="int" parameterType="String">
        SELECT COUNT(*)
        FROM user
        WHERE user_id = #{id} AND department_idx LIKE CONCAT(#{departmentIdx}, '%');
    </select>

    <select id="search" parameterType="oms.pc_protector.restApi.user.model.UserSearchInputVO"
            resultType="oms.pc_protector.restApi.user.model.UserVO">
        SELECT * FROM user
        WHERE 1 = 1
        AND department_idx LIKE CONCAT(#{UserIdx}, '%')
        <if test='userId != null and userId != ""'>
            AND user_id LIKE CONCAT('%',#{userId},'%')
        </if>
        <if test='name != null and name != ""'>
            AND name LIKE CONCAT('%',#{name},'%')
        </if>
        <if test='departmentIdx != null and departmentIdx != ""'>
            AND department_idx = #{departmentIdx}
        </if>
        <if test='phone != null and phone != ""'>
            AND phone LIKE CONCAT('%',#{phone},'%')
        </if>
        ORDER BY idx DESC
    </select>

    <update id="departmentModified" parameterType="oms.pc_protector.restApi.department.model.UpdateDepartmentVO">
        UPDATE user
        SET department = #{new_name}
        WHERE department = #{old_name}
    </update>

    <insert id="insertUserInfo" parameterType="String">
        INSERT INTO user (
            user_id
        )
        VALUES (
                   #{userId}
               )
    </insert>

    <insert id="insertUserInfoUserInfoFromAdmin" parameterType="oms.pc_protector.restApi.user.model.UserRequestVO">
        INSERT INTO user (user_id,
                          name,
                          email,
                          phone,
                          department,
                          department_idx)
        VALUES (#{userId},
                #{name},
                #{email},
                #{phone},
                #{department},
                #{departmentIdx})
    </insert>

    <insert id="RegisterUserInfo" parameterType="oms.pc_protector.restApi.user.model.UserVO">
        INSERT INTO user (user_id,
                          name,
                          email,
                          phone,
                          department,
                          department_idx)
        VALUES (#{userId},
                #{name},
                #{email},
                #{phone},
                #{department},
                #{departmentIdx})
    </insert>

    <update id="updateUserInfo_Front" parameterType="oms.pc_protector.restApi.user.model.RequestUserVO">
        UPDATE user
        SET user.user_id        = #{userId},
            user.name           = #{name},
            user.department     = #{department},
            user.department_idx = #{departmentIdx},
            user.email          = #{email},
            user.phone          = #{phone},
            user.update_time    = now()
        WHERE user.user_id = #{userId} AND department_idx LIKE CONCAT(#{UserIdx}, '%');
    </update>

    <delete id="deleteUserInfo" parameterType="String">
        DELETE
        FROM user
        WHERE user.user_id = #{id} AND department_idx LIKE CONCAT(#{UserIdx}, '%');
        DELETE c
        FROM client c, user u
        WHERE c.user_id = #{id} AND c.user_id = u.user_id AND u.department_idx LIKE CONCAT(#{UserIdx}, '%');
        DELETE ur
        FROM user_result ur, user u
        WHERE ur.user_id = #{id} AND ur.user_id = u.user_id AND u.department_idx LIKE CONCAT(#{UserIdx}, '%');
        DELETE ch
        FROM client_history ch, user u
        WHERE ch.user_id = #{id} AND ch.user_id = u.user_id AND u.department_idx LIKE CONCAT(#{UserIdx}, '%');
    </delete>

    <delete id="deleteAllUserInfo">
        DELETE
        FROM user
    </delete>

</mapper>


