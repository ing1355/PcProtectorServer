<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="oms.pc_protector.restApi.dashboard.mapper.DashboardMapper">

    <select id="selectAvgScoreByMonth" resultType="Integer"
            parameterType="String">

        SELECT NVL(AVG(score), 0)
        FROM user_result
        WHERE DATE_FORMAT(check_time, '%Y-%m-%d') BETWEEN #{startDate} AND #{endDate}
          AND in_schedule = 1
          AND (item1_result != 0
            OR item2_result != 0
            OR item3_result != 0
            OR item4_result != 0
            OR item5_result != 0
            OR item6_result != 0
            OR item7_result != 0
            OR item8_result != 0
            OR item9_result != 0
            OR item10_result != 0
            OR item11_result != 0
            OR item12_result != 0
            OR item13_result != 0
            OR item14_result != 0
            OR item15_result != 0
            OR item16_result != 0)
    </select>

    <select id="selectAvgScoreByRecentMonths"
            resultType="Integer"
            parameterType="String">
        SELECT NVL(AVG(t1.score),0)
        FROM (
                 SELECT *
                 FROM user_result
                 WHERE DATE_FORMAT(check_time, '%Y-%m') = #{month}
                   AND in_schedule = 1
                   AND (item1_result != 0
                     OR item2_result != 0
                     OR item3_result != 0
                     OR item4_result != 0
                     OR item5_result != 0
                     OR item6_result != 0
                     OR item7_result != 0
                     OR item8_result != 0
                     OR item9_result != 0
                     OR item10_result != 0
                     OR item11_result != 0
                     OR item12_result != 0
                     OR item13_result != 0
                     OR item14_result != 0
                     OR item15_result != 0
                     OR item16_result != 0)
                 GROUP BY user_id, ip_address, DATE_FORMAT(check_time, '%Y-%m-%d')) AS t1
    </select>

    <!--    <select id="selectAvgScoreByRecent6Months"-->
    <!--            resultType="Integer">-->
    <!--        SELECT AVG(t1.score)                        AS avgScore,-->
    <!--               DATE_FORMAT(t1.create_time, '%Y-%m') AS yearMonth-->
    <!--        FROM user AS t0,-->
    <!--             user_result as t1-->
    <!--                 left outer join user_result as t2-->
    <!--                                 on t1.ip_address = t2.ip_address-->
    <!--                                     AND (t1.create_time <![CDATA[<]]> t2.create_time-->
    <!--                                         OR (t1.create_time = t2.create_time AND t1.ip_address <![CDATA[<]]> t2.ip_address))-->
    <!--        where t2.ip_address is NULL-->
    <!--          AND t0.user_id = t1.user_id-->
    <!--        GROUP BY yearMonth-->
    <!--        ORDER BY yearMonth DESC-->
    <!--        LIMIT 6-->
    <!--    </select>-->

    <select id="selectUserCountByScore" resultType="Integer">
        SELECT COUNT(*)
        FROM (
                 SELECT *,
                        ROW_NUMBER() over (PARTITION BY user_id, ip_address ORDER BY check_time DESC) AS r0
                 FROM user_result
             ) AS t1

        WHERE t1.r0 = 1
          AND in_schedule = 1
          AND score BETWEEN #{startScore} AND #{endScore}
          AND t1.check_time BETWEEN #{startDate} AND #{endDate}
          AND (t1.item1_result != 0
            OR t1.item2_result != 0
            OR t1.item3_result != 0
            OR t1.item4_result != 0
            OR t1.item5_result != 0
            OR t1.item6_result != 0
            OR t1.item7_result != 0
            OR t1.item8_result != 0
            OR t1.item9_result != 0
            OR t1.item10_result != 0
            OR t1.item11_result != 0
            OR t1.item12_result != 0
            OR t1.item13_result != 0
            OR t1.item14_result != 0
            OR t1.item15_result != 0
            OR t1.item16_result != 0)
    </select>

    <select id="selectDashboardPeriod" resultType="oms.pc_protector.restApi.dashboard.model.DashboardPeriodVO">
        SELECT *
        FROM dashboard_period;
    </select>

    <update id="dashboardPeriodUpdate" parameterType="oms.pc_protector.restApi.dashboard.model.DashboardPeriodVO">
        UPDATE dashboard_period
        SET start_date = #{startDate},
            end_date   = #{endDate}
    </update>

</mapper>