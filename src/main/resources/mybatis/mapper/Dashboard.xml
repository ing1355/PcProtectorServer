<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="oms.pc_protector.restApi.dashboard.mapper.DashboardMapper">

    <select id="selectAvgScoreByMonth" resultType="Integer"
            parameterType="String">
        SELECT AVG(t1.score) AS avgScore
        FROM user AS t0,
             user_result as t1
                 left outer join user_result as t2
                                 on t1.ip_address = t2.ip_address
                                     AND (t1.create_time <![CDATA[<]]> t2.create_time
                                         OR (t1.create_time = t2.create_time AND t1.ip_address <![CDATA[<]]> t2.ip_address))
        where t2.ip_address is NULL
          AND t0.user_id = t1.user_id
          AND DATE_FORMAT(t1.create_time, '%Y-%m') = #{value}
    </select>

    <select id="selectAvgScoreByRecent1Months"
            resultType="oms.pc_protector.restApi.dashboard.model.ChartVO"
            parameterType="String">
        SELECT AVG(t1.score)                           AS avgScore,
               DATE_FORMAT(t1.create_time, '%Y-%m-%d') AS yearMonth
        FROM user AS t0,
             user_result as t1
                 left outer join user_result as t2
                                 on t1.ip_address = t2.ip_address
                                     AND (t1.create_time <![CDATA[<]]> t2.create_time
                                         OR (t1.create_time = t2.create_time AND t1.ip_address <![CDATA[<]]> t2.ip_address))
        where t2.ip_address is NULL
          AND t0.user_id = t1.user_id
        GROUP BY yearMonth
        ORDER BY yearMonth DESC
        LIMIT 12
    </select>

    <select id="selectAvgScoreByRecent6Months"
            resultType="oms.pc_protector.restApi.dashboard.model.ChartVO"
            parameterType="String">
        SELECT AVG(t1.score)                        AS avgScore,
               DATE_FORMAT(t1.create_time, '%Y-%m') AS yearMonth
        FROM user AS t0,
             user_result as t1
                 left outer join user_result as t2
                                 on t1.ip_address = t2.ip_address
                                     AND (t1.create_time <![CDATA[<]]> t2.create_time
                                         OR (t1.create_time = t2.create_time AND t1.ip_address <![CDATA[<]]> t2.ip_address))
        where t2.ip_address is NULL
          AND t0.user_id = t1.user_id
        GROUP BY yearMonth
        ORDER BY yearMonth DESC
        LIMIT 6
    </select>

    <select id="selectUserCountByScore" resultType="Integer"
            parameterType="int">
        SELECT COUNT(*)
        FROM (
                 SELECT DISTINCT t1.department,
                                 t1.user_id,
                                 t1.name,
                                 t2.ip_address,
                                 t2.os,
                                 t2.wrong_md5,
                                 t2.pc_protector_version
                 FROM USER AS t1
                          LEFT OUTER JOIN CLIENT AS t2 ON t1.user_id = t2.user_id
             ) AS A
                 LEFT OUTER JOIN (
            SELECT t1.*
            FROM USER AS t0,
                 user_result AS t1
                     LEFT OUTER JOIN user_result AS t2
                                     ON t1.ip_address = t2.ip_address AND t1.user_id = t2.user_id AND (t1.create_time
        <![CDATA[<]]>
                                                                                                       t2.create_time OR
                                                                                                       (t1.create_time = t2.create_time AND t1.ip_address <![CDATA[<]]> t2.ip_address))
            WHERE t2.ip_address IS NULL
              AND t0.user_id = t1.user_id
        ) AS B ON A.ip_address = B.ip_address AND A.user_id = B.user_id
        WHERE os IS NOT NULL
            AND score BETWEEN #{startScore} AND #{endScore}
           AND (item1_result != 0
           OR item2_result != 0
           OR item3_result != 0
           OR item4_result != 0
           OR item5_result != 0
           OR item6_result != 0
           OR item7_result != 0
           OR item8_result != 0
           OR item9_result != 0
           OR item10_result != 0
           OR item11_result != 0
           OR item12_result != 0
           OR item13_result != 0
           OR item14_result != 0
           OR item15_result != 0
           OR item16_result != 0)
            AND in_schedule = 1
    </select>

</mapper>


