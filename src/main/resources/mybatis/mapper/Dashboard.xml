<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="oms.pc_protector.restApi.dashboard.mapper.DashboardMapper">


    <select id="selectAvgScoreByMonth" resultType="Integer"
            parameterType="String">
        SELECT
               AVG(t1.score)
        FROM user AS t0, user_result as t1 left outer join user_result as t2
        on t1.ip_address = t2.ip_address
        AND (t1.create_time <![CDATA[<]]> t2.create_time
                 OR (t1.create_time = t2.create_time AND t1.ip_address <![CDATA[<]]> t2.ip_address))
        where t2.ip_address is NULL
        AND t0.user_id = t1.user_id
        AND DATE_FORMAT(t1.check_time,'%Y-%m') = #{yearMonth}
    </select>

    <select id="selectUserCountByScore" resultType="Integer"
            parameterType="int">
        SELECT
            COUNT(*)
        FROM user AS t0, user_result as t1 left outer join user_result as t2
        on t1.ip_address = t2.ip_address
        AND (t1.create_time <![CDATA[<]]> t2.create_time
                              OR (t1.create_time = t2.create_time AND t1.ip_address <![CDATA[<]]> t2.ip_address))
        where t2.ip_address is NULL
        AND t0.user_id = t1.user_id
        AND t1.score BETWEEN #{startScore} AND #{endScore}
    </select>

</mapper>


