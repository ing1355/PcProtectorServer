<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="oms.pc_protector.restApi.statistics.mapper.StatisticsMapper">


    <select id="selectStatisticsByDepartment" resultType="java.util.LinkedHashMap"
            parameterType="oms.pc_protector.restApi.statistics.model.StatisticsResponseVO">
        SELECT
        t1.score,
        t1.item1_result,
        t1.item2_result,
        t1.item3_result,
        t1.item4_result,
        t1.item5_result,
        t1.item6_result,
        t1.item7_result,
        t1.item8_result,
        t1.item9_result,
        t1.item10_result,
        t1.item11_result,
        t1.item12_result,
        t1.item13_result,
        t1.item14_result,
        t1.item15_result,
        t1.item16_result
        FROM user AS t0, user_result as t1 left outer join user_result as t2
        on t1.ip_address = t2.ip_address
        AND (t1.create_time <![CDATA[<]]> t2.create_time
        OR (t1.create_time = t2.create_time AND t1.ip_address <![CDATA[<]]> t2.ip_address))
        where t2.ip_address is NULL
        AND t0.user_id = t1.user_id
        AND t0.department_idx = #{departmentCode} AND t1.in_schedule = 1
        AND (t1.item1_result != 0
        OR t1.item2_result != 0
        OR t1.item3_result != 0
        OR t1.item4_result != 0
        OR t1.item5_result != 0
        OR t1.item6_result != 0
        OR t1.item7_result != 0
        OR t1.item8_result != 0
        OR t1.item9_result != 0
        OR t1.item10_result != 0
        OR t1.item11_result != 0
        OR t1.item12_result != 0
        OR t1.item13_result != 0
        OR t1.item14_result != 0
        OR t1.item15_result != 0
        OR t1.item16_result != 0)

        <if test="yearMonth != null">
            AND DATE_FORMAT(t1.check_time,'%Y-%m') = #{yearMonth}
        </if>
    </select>

    <select id="countClientByMonth" parameterType="oms.pc_protector.restApi.statistics.model.StatisticsResponseVO"
            resultType="int">
        SELECT COUNT(*) FROM (
        SELECT A.department_idx, A.user_id, B.ip_address
        FROM user as A, client as B
        WHERE A.user_id = B.user_id
        ) AS t0 LEFT OUTER JOIN
        (
        SELECT *,
        ROW_NUMBER() over (PARTITION BY user_id, ip_address ORDER BY check_time DESC) AS r0
        FROM user_result
        ) AS t1

        WHERE t1.r0 = 1 AND in_schedule = 1 AND t0.ip_address = t1.ip_address AND
        t0.user_id = t1.user_id
        <if test="value != null">
            AND DATE_FORMAT(t1.check_time, '%Y-%m') = #{yearMonth}
        </if>
    </select>

</mapper>


